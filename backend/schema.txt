กำหนด type ว่ามีอะไรบ้างห้ามมีนอกเหนือจากนี้

create type role as enum ('admin' , 'customer');

create type type_of_categorie as enum ('product','reward');

create type source as enum ('order' , 'promo');

create type roast_level as enum ('light','medium','dark');

create type stock_type as enum ('in','out');

CREATE TABLE customers (
    id SERIAL PRIMARY KEY, 
    username VARCHAR(255) not null unique ,
    password varchar(255) not null ,
    email VARCHAR(255) not null unique,
    first_name varchar(255) not null,
    last_name varchar(255) not null,
    role role not null,
    is_active Boolean default true,
    total_points int default 0 check (total_points >=0),
    created_at timestamp default CURRENT_TIMESTAMP not null,
    updated_at timestamp default current_timestamp not null
);

create table promo_code(
id serial primary key,
code varchar(50) unique not null,
points int not null check(points> 0),
max_usage int not null default 1 check(max_usage >0),
used_count int default 0 check(used_count >= 0),
is_active boolean default true,
created_at timestamp default current_timestamp not null,
constraint chk_usage check (used_count <= max_usage)
);

create table promo_code_usage(
id serial primary key,
promo_code_id int not null,
customer_id int  not null ,
points int not null check(points > 0),
created_at timestamp default current_timestamp not null,
foreign key (promo_code_id) references promo_code(id) on delete restrict,
foreign key (customer_id) references customers(id) on delete restrict,
unique (promo_code_id , customer_id)
);



create table collect_point_history (
id serial primary key,
customer_id int not null ,
points int not null,
source source not null ,
created_at timestamp default current_timestamp not null,
foreign key (customer_id) references customers(id) on delete restrict
);


create table categories (
id serial primary key,
name varchar(255) not null ,
type type_of_categorie not null,
parent_id int,
created_at timestamp default current_timestamp not null,
constraint fk_categories_parent
foreign key (parent_id) references categories(id)
on delete set null
);

create table products(
id serial primary key ,
name varchar(255) not null,
description varchar(255) not null,
price int not null check(price >=0),
stock int not null check(stock >=0),
category_id int not null ,
roast_level roast_level not null,
is_active boolean default true,
created_at timestamp default current_timestamp not null,
updated_at timestamp default current_timestamp not null,
foreign key (category_id) references categories(id) on delete restrict
);

create table rewards (
id serial primary key,
item_name varchar(255) not null,
description varchar(255) not null,
points_required int not null check(points_required > 0),
stock int not null check(stock >= 0),
category_id int not null,
is_active boolean default true ,
created_at timestamp default current_timestamp not null,
updated_at timestamp default current_timestamp not null,
foreign key (category_id) references categories(id) on delete restrict
);


create table orders (
id serial primary key,
customer_id int not null,
order_number varchar(100) unique not null,
total_price int not null check(total_price >= 0),
created_at timestamp default current_timestamp not null,
foreign key (customer_id) references customers(id) on delete restrict
);


create table order_items (
id serial primary key ,
order_id int not null ,
product_id int not null ,
quantity int not null check(quantity >0),
price int not null check(price >= 0),
foreign key (order_id) references orders(id) on delete cascade,
foreign key (product_id) references products(id) on delete restrict,
unique (order_id , product_id)
);


create table stock_movement (
id serial primary key,
product_id int not null ,
order_id int ,
quantity stock_type not null,
created_at timestamp default current_timestamp not null,
foreign key (product_id) references products(id) on delete restrict,
foreign key (order_id) references orders(id) on delete set null
);


create table redeem_history (
id serial primary key ,
customer_id int not null ,
reward_id int not null,
points_used int not null check(points_used >0),
created_at timestamp default current_timestamp not null,
foreign key (customer_id) references customers(id) on delete restrict,
foreign key (reward_id) references rewards(id) on delete restrict
);



create table payment (
id serial primary key,
order_id int unique not null,
amount int not null check(amount >=0),
transaction_ref varchar(100) unique not null,
paid_at timestamp default current_timestamp not null,
created_at timestamp default current_timestamp not null,
foreign key (order_id) references orders(id) on delete cascade
);

create table product_images (
id serial primary key,
product_id int not null,
image_url varchar(500) not null,
is_primary boolean default false,
sort_order int default 0,
created_at timestamp default current_timestamp not null,
foreign key (product_id) references products(id) on delete cascade
)

create table reward_images(
id serial primary key,
reward_id int not null,
image_url varchar(500) not null,
is_primary boolean default false,
sort_order int default 0,
created_at timestamp default current_timestamp not null,
foreign key (reward_id) references rewards(id) on delete cascade
)

create table users_address(
    id serial primary key,
    user_id int not null,
    address_line text not null,
    province varchar(100) not null ,
    country varchar(255) not null,
    district varchar(255) not null,
    subdistrict varchar(255) not null
    postal_code varchar(100) not null,
    is_default boolean default false,
    created_at timestamp default current_timestamp not null,
    updated_at timestamp default current_timestamp not null,
    foreign key (user_id) references users(id) on delete cascade
)


สร้าง index ในการค้นหาให้ไวขึ้น

create index idx_orders_customer on orders(customer_id);
create index idx_order_items_order on order_items(order_id);
create index idx_order_items_product on order_items(product_id);
create index idx_stock_product on stock_movement(product_id);
create index idx_redeem_customer on redeem_history(customer_id);
create index idx_promo_usage_customer on promo_code_usage(customer_id);


สร้างฟังชั่นสำหรับทำ trigger

create or replace function set_updated_at()
returns trigger as $$
begin
	new.updated_at = current_timestamp;
return new;
end;
$$ language plpgsql;


สร้างปุ่ม trigger สำหรับทำ update

create trigger trigger_customers_updated_at
before update on customers
for each row
execute function set_updated_at();


create trigger trigger_rewards_updated_at
before update on rewards
for each row
execute function set_updated_at();

create trigger trigger_products_updated_at
before update on products
for each row
execute function set_updated_at();


